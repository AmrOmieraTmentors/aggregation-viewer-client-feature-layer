<!--
  Copyright 1995-2017 Esri

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

  For additional information, contact:
  Environmental Systems Research Institute, Inc.
  Attn: Contracts Dept
  380 New York Street
  Redlands, California, USA 92373

  email: contracts@esri.com
-->

<html>

<head lang="en">
  <meta charset="UTF-8">
  <title>Aggregation Viewer - Client Side Feature Layer</title>
  <link rel="stylesheet" href="https://js.arcgis.com/3.19/dijit/themes/claro/claro.css">
  <link rel="stylesheet" href="https://js.arcgis.com/3.19/esri/css/esri.css">

  <style type="text/css">
    html,
    body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      font-size: 12px;
    }
    
    #map {
      height: -moz-calc(100% - 190px);
      height: -webkit-calc(100% - 190px);
      height: calc(100% - 190px);
      width: 100%;
      z-index: -1;
    }
    
    #controls {
      position: absolute;
      bottom: 0px;
      width: 100%;
      height: 180px;
      background: rgba(255, 255, 255, 0);
      padding: 2px 0px;
      white-space: nowrap;
      color: #6f6e6e;
    }
    
    .settingsTable {
      border-color: rgba(255, 255, 255, 0.6);
      font-family: sans-serif;
      font-size: 12px;
      color: #6f6e6e;
      text-align: left;
      overflow: left;
      width: 100%;
      vertical-align: text-top;
    }
    
    .settingsTable td {
      vertical-align: top;
      padding: 1px 2px;
    }
  </style>
  <script src="https://js.arcgis.com/3.19/"></script>
  <script>
    require([
      "dojo/dom",
      "dojo/dom-style",
      "dojo/on",
      "dojo/json",
      "dojo/_base/array",

      "esri/map",
      "esri/graphic",
      "esri/SpatialReference",
      "esri/Color",
      "esri/request",
      "esri/InfoTemplate",
      "esri/TimeExtent",

      "esri/layers/FeatureLayer",
      "esri/layers/LabelClass",

      "esri/symbols/SimpleLineSymbol",
      "esri/symbols/SimpleFillSymbol",
      "esri/symbols/TextSymbol",
      "esri/geometry/Polygon",

      "esri/dijit/TimeSlider",

      "esri/renderers/HeatmapRenderer",
      "esri/renderers/ClassBreaksRenderer",

      "dojo/_base/array",
      "dojo/domReady!"
    ], function (dom, domStyle, on, JSON, arr, Map, Graphic, SpatialReference, Color, esriRequest, InfoTemplate, TimeExtent, FeatureLayer, LabelClass, SimpleLineSymbol, SimpleFillSymbol, TextSymbol, Polygon, TimeSlider, HeatmapRenderer, ClassBreaksRenderer, array) {

      //### global variables ###
      var map;
      var timePara;
      var replay = false;
      var live = false;
      var startTimeSlider = true;
      var minValue;
      var maxValue;
      var ignoreChangeEvent = false;

      //#############################################################################################
      // Map Related functions
      //#############################################################################################

      esri.config.defaults.io.corsEnabledServers.push('http://storm.esri.com');
      esri.config.defaults.io.corsEnabledServers.push('http://storm.esri.com:6080');
      esri.config.defaults.io.corsEnabledServers.push('https://storm.esri.com:6443');

      map = new Map("map", {
        basemap: "topo",
        center: [-96, 36.428],
        zoom: 4,
        showLabels: true
      });

      //### On Map load continue ###

      map.on("load", function () {
        getLayerTimeInfo();
        createHeatmapLayer();
        addAggregationLayer();
      });

      //### Issue new query on extent-change if live mode is disabled ###

      map.on("extent-change", function (evt) {
        if (map.getLayer("FSAggregations") && !ignoreChangeEvent && live == false) {
          getFSAggregation();
        };
      });

      //#############################################################################################
      // UI Related functions
      //#############################################################################################

      //### UI event listener ###

      on(dojo.byId("addFSLayer"), "click", function () {
        getLayerTimeInfo();
        setTimeout(function () {
          addAggregationLayer();
        }, 1000);
      });
      on(dojo.byId("heatmap"), "change", toggleHeatmap);
      on(dojo.byId("refreshMode"), "change", toggleMode);
      on(dojo.byId("autoOffSet"), "change", toggleRefresh);
      on(dojo.byId("aggStyle"), "change", toggleRefresh);
      on(dojo.byId("lod"), "change", toggleRefresh);
      on(dojo.byId("blurRadius"), "change", toggleRefresh);

      //### Switch change functions ###

      function toggleMode(evt) {
        console.log(evt.target.value);
        if (evt.target.value == "manual") {
          live = false;
          replay = false;
          domStyle.set(dom.byId('timeSlider'), "display", 'none');
          map.setTimeSlider(null);
          map.setTimeExtent(null);
          getFSAggregation();
        } else if (evt.target.value == "live") {
          live = true;
          replay = false;
          autoUpdate();
          domStyle.set(dom.byId('timeSlider'), "display", 'none');
          map.setTimeSlider(null);
          map.setTimeExtent(null);
        } else if (evt.target.value == "replay") {
          live = false;
          replay = true;
          if (startTimeSlider == true) {
            initTimeSlider();
            startTimeSlider = false;
          } else if (startTimeSlider == false) {
            ignoreChangeEvent = true;
            updateTimeSlider();
          };
        };
      };

      function toggleHeatmap(evt) {
        if (dojo.byId("heatmap").checked == true) {
          dojo.byId("radius").style.visibility = "visible";
          var layer = map.getLayer("heatmap");
          var minIsFinit = isFinite(minValue);
          var maxIsFinit = isFinite(maxValue);
          if (!minIsFinit) {
            minValue = 0;
          }
          if (!maxIsFinit) {
            maxValue = 1;
          }
          layer.renderer.setMinPixelIntensity(minValue);
          layer.renderer.setMaxPixelIntensity(maxValue);
        } else {
          dojo.byId("radius").style.visibility = "hidden";
        }
        getFSAggregation();
      }

      function toggleRefresh(evt) {
        if (live == false) {
          getFSAggregation();
        }
      }


      //#############################################################################################
      // Layer related functions
      //#############################################################################################


      //### Add Aggregation Layer ###

      function addAggregationLayer() {
        var layerDefinition = {
          "geometryType": "esriGeometryPolygon",
          "fields": [{
            "name": "objectid",
            "type": "esriFieldTypeInteger",
            "alias": "objectid"
                }, {
            "name": "Geohash",
            "type": "esriFieldTypeString",
            "alias": "Geohash"
                }, {
            "name": "Count",
            "type": "esriFieldTypeInteger",
            "alias": "Count"
                }, {
            "name": "Geometry",
            "type": "esriFieldTypeGeometry",
            "alias": "Geometry"
                }]
        };
        var featureCollection = {
          layerDefinition: layerDefinition,
          featureSet: null
        };
        var infoTemplate = new InfoTemplate("Attributes", "${*}");
        var FSAggregationLayer = new FeatureLayer(featureCollection, {
          id: "FSAggregations",
          objectIdField: "objectid",
          showLabels: true,
          infoTemplate: infoTemplate,
          outFields: ["*"]
        });
        FSAggregationLayer.setRenderer(createRenderer("Aggregation"));
        var label = createRenderer("Label");
        FSAggregationLayer.setLabelingInfo([label]);
        map.addLayer(FSAggregationLayer);
        console.log("Client FS Aggregation Layer added");
        getFSAggregation();
      };

      //### Heat Map Feature Layer ###

      function createHeatmapLayer() {
        var layerDefinition = {
          "geometryType": "esriGeometryPoint",
          "fields": [{
            "name": "objectid",
            "type": "esriFieldTypeInteger",
            "alias": "objectid"
                }, {
            "name": "Geohash",
            "type": "esriFieldTypeString",
            "alias": "Geohash"
                }, {
            "name": "Count",
            "type": "esriFieldTypeInteger",
            "alias": "Count"
                }, {
            "name": "geometry",
            "type": "esriFieldTypeGeometry",
            "alias": ""
                }]
        };
        var featureCollection = {
          layerDefinition: layerDefinition,
          featureSet: null
        };
        var heatmapLayer = new FeatureLayer(featureCollection, {
          id: "heatmap",
          objectIdField: "objectid",
          visible: true,
          opacity: 1
        });
        heatmapLayer.setRenderer(createRenderer("Heatmap"));
        map.addLayer(heatmapLayer);
        console.log("Heatmap Layer added");
      };

      //### FeatureLayer Time Info query###

      function getLayerTimeInfo() {
        var url = dojo.byId("inputUrl").value + "?f=json";
        var request = esriRequest({
          "url": url,
          "handleAs": "json",
          "callbackParamName": "callback"
        });
        request.then(
          function (response) {
            timePara = new TimeExtent(new Date(response.timeInfo.timeExtent[0]), new Date(response.timeInfo.timeExtent[1]));
          },
          function (error) {
            console.log("Error getting the layers time extent: ", error.message);
          });
      };

      //#############################################################################################
      //Create Renderer or Labels
      //#############################################################################################
      //
      function createRenderer(type) {

        //### Aggregation Renderer ###
        if (type == "Aggregation") {
          //Define default symbol
          var symbol = new SimpleFillSymbol();
          symbol.setColor(new Color([150, 150, 150, 0.3]))
            .setOutline(new SimpleLineSymbol().setColor(new Color("white")).setWidth(0.3));
          //Function to create symbol for breaks with a given color
          function createSymbol(color) {
            return new SimpleFillSymbol()
              .setColor(color)
              .setOutline(
                new SimpleLineSymbol().setColor(new Color([99, 99, 99, 1])).setWidth(0.3)
              );
          };
          classColorInfo = [];

          //Define breaks and color
          var renderer = new ClassBreaksRenderer({
            field: "Count",
            defaultSymbol: symbol,
            normalizationType: "percent-of-total",
            normalizationTotal: 100,
            classBreakInfos: [
              {
                minValue: 0,
                maxValue: 10,
                symbol: createSymbol(new Color([254, 240, 217, 0.7]))
                                                },
              {
                minValue: 10,
                maxValue: 20,
                symbol: createSymbol(new Color([253, 212, 158, 0.7]))
                                                    },
              {
                minValue: 20,
                maxValue: 30,
                symbol: createSymbol(new Color([253, 187, 132, 0.8]))
                                                        },
              {
                minValue: 30,
                maxValue: 40,
                symbol: createSymbol(new Color([252, 141, 89, 0.8]))
                                                            },
              {
                minValue: 40,
                maxValue: 60,
                symbol: createSymbol(new Color([239, 101, 72, 0.9]))
                                                            },
              {
                minValue: 60,
                maxValue: 80,
                symbol: createSymbol(new Color([215, 48, 31, 0.9]))
                                                            },
              {
                minValue: 80,
                maxValue: 100,
                symbol: createSymbol(new Color([153, 0, 0, 1]))
                        }]
          });


          //### HeatMap Renderer ###
        } else if (type == "Heatmap") {
          var renderer = new HeatmapRenderer({
            colorStops: [
              {
                ratio: 0,
                color: "rgba(250, 0, 0, 0)"
                    },
              {
                ratio: 0.3,
                color: "rgba(0,128,255, 1)"
                    },
              {
                ratio: 0.4,
                color: "rgba(115,185,139, 1)"
                    },
              {
                ratio: 0.5,
                color: "rgba(185,220,69, 1)"
                    },
              {
                ratio: 0.6,
                color: "rgba(255,255,0, 1)"
                    },
              {
                ratio: 0.7,
                color: "rgb(255,220,0)"
                    },
              {
                ratio: 0.9,
                color: "rgb(255,174,0)"
                    },
              {
                ratio: 0.97,
                color: "rgb(255,112,0)"
                    },
              {
                ratio: 0.98,
                color: "rgb(255,80,0)"
                    },
              {
                ratio: 0.999,
                color: "rgb(255, 0, 0)"
                    }],
            blurRadius: 12,
            field: "Count"
          });

          //### Add Labels ###
        } else if (type == "Label") {

          //create a text symbol and renderer to define the style of labels
          var labelJson = {
            "labelExpressionInfo": {
              "value": "{Count}"
            },
            "labelPlacement": "always-horizontal"
          };
          var lc = new LabelClass(labelJson);
          var gridLabel = new TextSymbol().setColor(new Color([0, 0, 0]));
          gridLabel.font.setSize("8pt");
          gridLabel.font.setFamily("arial");
          lc.symbol = gridLabel;
          var renderer = lc;
        }
        return renderer;
      }

      //#############################################################################################
      // BDS FS Aggregation Query
      //############################################################################################# 
      function constructURL() {
        //Get parameters from UI
        if (replay) {
          var start = timePara.startTime.getTime();
          var end = timePara.endTime.getTime();
        } else {
          var start = 0;
          var end = new Date().getTime();
        };
        var ext = encodeURIComponent(JSON.stringify(map.extent.toJson()));
        var lod = dojo.byId("lod").value;
        var style = dojo.byId("aggStyle").value;
        if (dojo.byId("autoOffSet").checked == true) {
          if (style == "flatHexagon" || style == "pointyHexagon" || style == "square") {
            lod = (parseInt(lod) + 5).toString();
          } else if (style == "flatTriangle" || style == "pointyTriangle") {
            lod = (parseInt(lod) + 4).toString();
          };
        };

        //Construct URL for aggregation query
        var url = dojo.byId("inputUrl").value;
        url += "/query?lod=" + lod + "&lodType=" + style + "&outSR=102100&returnGeometry=true&geometryType=esriGeometryEnvelope&geometry=" + ext + "&time=" + start + "," + end + "&f=pjson";
        console.log(url);
        return url;
      }

      function getFSAggregation() {
        var url = constructURL();
        var request = esriRequest({
          "url": url,
          "handleAs": "json",
          "callbackParamName": "callback"
        });
        request.then(
          function (response) {
            console.log(response);
            var count = [];
            //Create graphics from response features
            var features = arr.map(response.features, function (feature, i) {
                var newFeature = {};
                var geometry;
                var attributes = {};
                count.push(feature.attributes.Count);
                geometry = new Polygon(feature.geometry)
                if (!geometry.hasOwnProperty('spatialReference') || !geometry['spatialReference']) {
                  geometry['spatialReference'] = sr;
                };
                if (dojo.byId("heatmap").checked == true) {
                  geometry = geometry.getCentroid();
                };
                newFeature = new Graphic(geometry, null, feature.attributes, null);
                return newFeature;
              })
              //Calculate min/max count value to adjust renderer
            maxValue = Math.max.apply(null, count);
            minValue = Math.min.apply(null, count);
            //Add features to respective layer and adjust renderer
            if (dojo.byId("heatmap").checked == true) {
              var layer = map.getLayer("heatmap");
              layer.renderer.setBlurRadius(dojo.byId("blurRadius").value);
            } else {
              var layer = map.getLayer("FSAggregations");
              layer.renderer.normalizationTotal = maxValue;
            }
            //Update features in the client side layer
            map.getLayer("FSAggregations").clear();
            map.getLayer("heatmap").clear();
            map.getLayer("heatmap").refresh();
            layer.applyEdits(features, null, null)
              .then(function () {
                layer.refresh();
              });
          },
          function (error) {
            console.log("Error querying the aggregations: ", error.message);
          });
      }
      //#############################################################################################
      //Other Functions
      //#############################################################################################
      //

      //
      //TimeSlider (init & update incl. labels)
      //
      function initTimeSlider() {
        timeSlider = new TimeSlider({
          style: "width: 100%;"
        }, dom.byId("timeSlider"));
        map.setTimeSlider(timeSlider);
        timeSlider.setThumbCount(2);
        timeSlider.createTimeStopsByCount(timePara, 21);
        timeSlider.setThumbIndexes([0, 21]);
        timeSlider.setThumbMovingRate(2000);
        timeSlider.startup();
        timeSlider.on("time-extent-change", function () {
          if (!ignoreChangeEvent) {
            timePara = timeSlider.getCurrentTimeExtent();
            getFSAggregation();
          };
        });
        //add labels for every other time stop
        var labels = createLabels();
        timeSlider.setLabels(labels);
      }

      function updateTimeSlider() {
        getLayerTimeInfo();
        setTimeout(function () {
          timeSlider.createTimeStopsByCount(timePara, 21);
          timeSlider.setThumbIndexes([0, 21]);
          timeSlider.startup();
          map.setTimeSlider(timeSlider);
          //add labels for every other time stop
          var labels = createLabels();
          timeSlider.setLabels(labels);
          domStyle.set(dom.byId('timeSlider'), "display", 'block');
          getFSAggregation();
          ignoreChangeEvent = false;
        }, 1000);
      };

      //Timeslider labels
      function createLabels() {
        var labels = array.map(timeSlider.timeStops, function (timeStop, i) {
          if (i % 2 === 0) {
            if (timeStop.getHours() < 10) {
              var hours = "0" + timeStop.getHours();
            } else {
              var hours = timeStop.getHours();
            };
            if (timeStop.getMinutes() < 10) {
              var minutes = "0" + timeStop.getMinutes();
            } else {
              var minutes = timeStop.getMinutes();
            };
            if (timeStop.getSeconds() < 10) {
              var seconds = "0" + timeStop.getSeconds();
            } else {
              var seconds = timeStop.getSeconds();
            };
            var month = timeStop.getMonth() + 1;
            var day = timeStop.getDate();
            //return hours + ":" + minutes;
            return month + "/" + day + "<br>" + hours + ":" + minutes + ":" + seconds;
          } else {
            return "";
          };
        });
        return labels;
      }

      function autoUpdate() {
        setTimeout(function () {
          getFSAggregation();
          if (live) {
            autoUpdate();
          };
        }, 2000);
      };

    });
  </script>
</head>

<body>
  <div id="map"></div>
  <div id="controls">
    <div style="margin-left: 10px;">
      <b>Service URL:</b>
      <input type="text" id="inputUrl" value="http://storm.esri.com:6080/arcgis/rest/services/faa-4326-hex-flat/MapServer/0" style="width: 700px; margin-bottom: 5px" />
      <input type="button" class="button" id="addFSLayer" value="Add Layer" />
      <table id="settingsTable" class="settingsTable">
        <th>Aggregation Settings</th>
        <tr>
          <td>
            <table class="settingsTable">
              <tr>
                <td>LOD:</td>
                <td>
                  <input type="number" id="lod" value="3" style="width: 50px;" />
                </td>
              </tr>
              <tr>
                <td>Auto LOD offset:</td>
                <td>
                  <input type="checkbox" id="autoOffSet" checked="true" />
                </td>
              </tr>

            </table>
          </td>
          <td>
            <table class="settingsTable">
              <tr>
                <td>GeoHash Style:</td>
                <td>
                  <select name="aggStyle" id="aggStyle" style="width: 120px;">
                    <option value="geohash">GeoHash</option>
                    <option value="square">Square</option>
                    <option value="flatHexagon">Flat Hexagon</option>
                    <option value="pointyHexagon">Pointy Hexagon</option>
                    <option value="flatTriangle">Flat Triangle</option>
                    <option value="pointyTriangle">Pointy Triangle</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>
                  Heatmap:
                  <input type="checkbox" id="heatmap" />
                </td>
                <td id="radius" style="visibility:hidden">
                  BlurRadius:
                  <input type="number" id="blurRadius" value="10" style="width: 40px;" />
                </td>
              </tr>
            </table>
          </td>
          <td>
            <table class="settingsTable">
              <tr>
                <td>
                  <center>Mode:
                    <form id="refreshMode" style="border:1px;border-style:solid;padding:1px">
                      <input type="radio" name="mode" value="manual" checked> Manual
                      <br>
                      <input type="radio" name="mode" value="live"> Live
                      <br>
                      <input type="radio" name="mode" value="replay"> Replay
                    </form>
                  </center>
                </td>
                <td style="width:1000px;">
                  <div id="timeSlider"></div>
                </td>
              </tr>
            </table>
          </td>
        </tr>
      </table>
    </div>
  </div>
</body>